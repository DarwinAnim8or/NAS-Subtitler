<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="brand.cloud">
    <%= typeof title !=='undefined' ? title : 'Cloud Files' %>
  </title>
  <style>
    :root {
      --bg: #f5f7ff;
      --panel: #ffffff;
      --muted: #97a0b3;
      --text: #1f2937;
      --primary: #6c8cff;
      --primary-600: #5a76ff;
      --shadow: 0 12px 40px rgba(29, 38, 58, .08);
      --ring: 0 0 0 4px rgba(108, 140, 255, .12);
      --radius: 16px;
      --sidebar-width: 260px;
      --topbar-height: 64px;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.6 -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Microsoft Yahei', sans-serif;
      overflow: hidden
    }

    body.i18n-hide {
      visibility: hidden
    }

    a {
      color: inherit;
      text-decoration: none
    }

    /* Layout */
    .app {
      height: 100vh;
      display: grid;
      grid-template-columns: 260px minmax(0, 1fr)
    }

    .sidebar {
      background: var(--panel);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      height: 100vh;
      overflow: auto
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 18px
    }

    .brand .logo {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      background: linear-gradient(135deg, #7aa1ff, #a9b7ff);
      display: grid;
      place-items: center;
      color: #fff;
      font-weight: 800
    }

    .nav {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px
    }

    .nav a {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      color: #4b5563
    }

    .nav a:hover {
      background: #f2f5ff
    }

    .nav a.active {
      background: linear-gradient(180deg, #eef3ff, #e8eeff);
      box-shadow: var(--shadow);
      color: #111827
    }

    .nav svg {
      width: 18px;
      height: 18px
    }

    .side-illustration {
      margin-top: auto;
      background: linear-gradient(180deg, #eef3ff, #ffffff);
      border: 1px solid #eef2fb;
      border-radius: 14px;
      padding: 16px;
      text-align: center;
      box-shadow: var(--shadow)
    }

    .main {
      padding: 18px;
      margin-top: var(--topbar-height);
      height: calc(100vh - var(--topbar-height));
      overflow: hidden;
      background: var(--panel)
    }

    /* 独立滚动容器：桌面端启用滚动 */
    .main-scroll {
      height: 100%;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      scrollbar-width: none;
      -ms-overflow-style: none;
      background: #F2F4F8;
      border-radius: var(--radius);
      padding: 16px;
      padding-top: calc(16px + var(--secHeadH, 0px));
      padding-bottom: calc(16px + var(--pagiH, 0px))
    }

    .main-scroll::-webkit-scrollbar {
      width: 0;
      height: 0
    }

    /* Topbar */
    .topbar {
      position: fixed;
      top: 0;
      left: var(--sidebar-width);
      width: calc(100% - var(--sidebar-width));
      height: var(--topbar-height);
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px 24px;
      background: var(--panel);
      z-index: 3
    }

    .search {
      flex: 0 1 360px;
      max-width: 420px;
      min-width: 260px;
      background: var(--panel);
      border: 1px solid #edf0f7;
      height: 42px;
      border-radius: 999px;
      padding: 0 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: var(--shadow)
    }

    .search input {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      font-size: 14px
    }

    /* 新增：状态文本样式 */
    .status {
      color: #4b5563;
      font-weight: 700
    }

    .actions {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-left: auto
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: none;
      border-radius: 999px;
      height: 40px;
      padding: 0 16px;
      background: var(--primary);
      color: #fff;
      font-weight: 600;
      box-shadow: var(--shadow);
      cursor: pointer
    }

    /* 新增：文字样式按钮（用于顶栏“指定目录”） */
    .btn-text {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      height: 40px;
      padding: 0 4px;
      border: none;
      background: transparent;
      color: var(--primary);
      font-weight: 700;
      box-shadow: none;
      cursor: pointer
    }

    .btn-text:hover {
      color: #2d3c8f;
      text-decoration: underline
    }

    /* 新增：翻译状态与分隔符样式 */
    .translating-info {
      color: #6b7280;
      font-weight: 700
    }

    .divider {
      width: 1px;
      height: 20px;
      background: #e5e7eb;
      margin: 0 8px
    }

    /* 新增：设置提示与文字链接样式 */
    .setting-hint {
      color: #6b7280;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 6px
    }

    .text-link {
      color: var(--primary);
      font-weight: 700;
      text-decoration: none;
      cursor: pointer
    }

    .text-link:hover {
      color: #2d3c8f;
      text-decoration: underline
    }

    .btn:hover {
      background: var(--primary-600)
    }

    .lang-select {
      height: 40px;
      border-radius: 999px;
      border: 1px solid #edf0f7;
      background: #fff;
      padding: 0 12px;
      color: #4b5563;
      font-weight: 600;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center
    }

    /* Section card */
    .section {
      margin-top: 18px;
      background: var(--panel);
      border-radius: 22px;
      padding: 22px;
      box-shadow: var(--shadow);
      border: 1px solid #edf0f7
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px
    }

    .title {
      font-size: 22px;
      font-weight: 700
    }

    .sub {
      color: var(--muted);
      font-size: 13px;
      margin-left: 10px
    }

    .muted {
      color: var(--muted);
      font-size: 13px
    }

    /* Files container: grid & list layouts */
    .files.grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px
    }

    .files.list {
      display: flex;
      flex-direction: column;
      gap: 10px
    }

    .card {
      background: #fafbff;
      border: 1px solid #eef2fb;
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow)
    }

    .card.pad {
      padding: 18px
    }

    /* Grid item layout */
    .files.grid .card {
      display: grid;
      grid-template-columns: 46px 1fr;
      align-items: center;
      gap: 12px
    }

    /* List item layout */
    .files.list .card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px
    }

    .icon {
      width: 46px;
      height: 46px;
      border-radius: 14px;
      display: grid;
      place-items: center;
      background: #eef2ff
    }

    .name {
      font-weight: 600
    }

    .meta {
      color: var(--muted);
      font-size: 12px
    }

    .size {
      margin-left: auto;
      color: #6b7280;
      font-weight: 600
    }

    .meta-row {
      display: flex;
      align-items: center;
      gap: 12px
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 8px
    }

    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #f3f6ff;
      border: 1px solid #e3e9ff;
      padding: 8px;
      border-radius: 12px;
      color: #6b7280;
      cursor: pointer
    }

    .toggle[aria-pressed="true"],
    .toggle.active {
      box-shadow: var(--ring)
    }

    .toggle svg {
      width: 16px;
      height: 16px
    }

    /* Toggle icons state */
    #viewToggle .i-list {
      display: none
    }

    #viewToggle[data-view="list"] .i-grid {
      display: none
    }

    #viewToggle[data-view="list"] .i-list {
      display: inline
    }

    @media (max-width: 1200px) {
      .files.grid {
        grid-template-columns: repeat(3, 1fr)
      }
    }

    @media (max-width: 920px) {
      .app {
        grid-template-columns: 1fr
      }

      .sidebar {
        position: sticky;
        top: 0;
        z-index: 2;
        border-right: none;
        height: auto;
        overflow: visible
      }

      .main {
        height: auto;
        overflow: visible;
        padding: 18px;
        margin-top: 0;
        background: var(--panel)
      }

      /* 移动端：避免嵌套滚动 */
      .main-scroll {
        height: auto;
        overflow: visible;
        padding: 0
      }

      .topbar {
        position: static;
        left: auto;
        width: 100%;
        height: auto;
        padding: 0;
        background: #fff;
        border-bottom: none;
        box-shadow: none;
        z-index: auto
      }

      .search {
        flex: 1
      }
    }

    @media (max-width: 680px) {
      .files.grid {
        grid-template-columns: repeat(2, 1fr)
      }

      .actions .btn span {
        display: none
      }

      /* 新增：顶栏左侧按钮在小屏也隐藏文字，仅保留图标 */
      .topbar>.btn-text span {
        display: none
      }

      /* 新增：小屏隐藏翻译状态与分隔符，避免拥挤 */
      .topbar .divider {
        display: none
      }

      /* 调整：小屏不再隐藏运行中任务文案，改为显示 */
      .topbar .translating-info {
        display: inline
      }

      /* 新增：小屏隐藏未设置提示与链接 */
      .topbar .setting-hint {
        display: none
      }
    }

    /* Element Plus 覆盖，令选择器更贴合顶部胶囊风格 */
    #langSwitchApp {
      width: 160px
    }

    #langSwitchApp .el-select {
      width: 100%
    }

    #langSwitchApp .el-input__wrapper {
      background: transparent;
      box-shadow: none;
      border: none;
      padding: 0;
      height: 40px
    }

    #langSwitchApp .el-input__inner {
      height: 40px;
      line-height: 40px;
      color: #4b5563;
      font-weight: 600
    }

    #langSwitchApp .el-select__caret {
      color: #9aa3b2
    }

    /* Sticky pagination at bottom of scroll container */
    .sticky-pagination {
      position: sticky;
      bottom: 0;
      z-index: 2;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      background: #fff;
      padding: 8px 0;
      margin-top: 12px;
      border-top: 1px solid #edf0f7
    }

    /* Sticky header in section so only middle list scrolls */
    .section-sticky-header {
      position: sticky;
      top: 0;
      z-index: 2;
      background: #fff;
      padding-top: 4px;
      padding-bottom: 6px
    }

    .section-sticky-header::after {
      content: "";
      display: block;
      height: 8px;
      margin: -2px 0 8px 0;
      border-bottom: 1px solid #edf0f7;
      box-shadow: 0 8px 18px rgba(29, 38, 58, .06)
    }
  </style>
  <!-- 引入 Vue 3 与 Element Plus（CDN，全局构建，最小侵入） -->
  <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/element-plus/dist/index.full.min.js"></script>
  <!-- Element Plus locales via CDN -->
  <script src="https://unpkg.com/element-plus/dist/locale/zh-cn"></script>
  <script src="https://unpkg.com/element-plus/dist/locale/en"></script>
  <script src="https://unpkg.com/element-plus/dist/locale/zh-tw"></script>
  <script src="https://unpkg.com/element-plus/dist/locale/fr"></script>
  <script src="https://unpkg.com/element-plus/dist/locale/es"></script>
  <script src="https://unpkg.com/element-plus/dist/locale/ru"></script>
  <script src="https://unpkg.com/element-plus/dist/locale/de"></script>
  <script src="https://unpkg.com/element-plus/dist/locale/ja"></script>
  <script src="https://unpkg.com/element-plus/dist/locale/ko"></script>
</head>

<body class="i18n-hide">
  <div class="app">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="brand">
        <div class="logo">☁</div>
        <span>Nas Subtitler</span>
      </div>
      <nav class="nav">
        <a href="/home" class="<%= (typeof navActive!=='undefined' && navActive==='home') ? 'active' : '' %>"><svg
            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10 3H3v7h7V3Zm11 0h-7v7h7V3ZM10 14H3v7h7v-7Zm11 0h-7v7h7v-7Z" />
          </svg><span data-i18n="nav.dashboard">Dashboard</span></a>
        <a href="/blank" class="<%= (typeof navActive!=='undefined' && navActive==='files') ? 'active' : '' %>"><svg
            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 7h18M3 12h18M3 17h18" />
          </svg><span data-i18n="nav.files">Files</span></a>
        <a href="/settings"
          class="<%= (typeof navActive!=='undefined' && navActive==='settings') ? 'active' : '' %>"><svg
            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="5" width="18" height="14" rx="2" />
            <circle cx="8" cy="12" r="3" fill="currentColor" />
          </svg><span data-i18n="nav.settings">Settings</span></a>
      </nav>
      <div class="side-illustration">
        <div style="display:flex;flex-direction:column;align-items:center;gap:6px;text-align:center">
          <svg width="96" height="72" viewBox="0 0 120 90" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <defs>
              <linearGradient id="g1" x1="0" x2="1" y1="0" y2="1">
                <stop offset="0%" stop-color="#7aa1ff" />
                <stop offset="100%" stop-color="#8ec5ff" />
              </linearGradient>
            </defs>
            <rect x="10" y="20" rx="10" ry="10" width="70" height="50" fill="url(#g1)" opacity="0.9" />
            <circle cx="90" cy="60" r="14" fill="#4f68ff" />
            <rect x="20" y="30" width="50" height="6" rx="3" fill="#fff" opacity=".9" />
            <rect x="20" y="42" width="38" height="6" rx="3" fill="#fff" opacity=".8" />
            <path d="M98 70 L112 84" stroke="#2d3c8f" stroke-width="6" stroke-linecap="round" />
          </svg>
          <div style="font-weight:700;font-size:13px" data-i18n="slogan.oneStop">One-stop translation management</div>
          <!-- 移除底部说明小字，根据需求不再显示 -->
        </div>
      </div>
    </div>

    <!-- 顶部导航（从 main 中移出并固定） -->
    <div class="topbar" role="toolbar">
      <div style="display: flex;">
        <div id="topStatusWrap" class="top-status">
          <div class="status" id="dirStatusInfo" data-i18n="files.loading"></div>
        </div>
      </div>


      <!-- 替换：动态任务信息显示 -->
      <div class="translating-info" style="display:none"><span id="currentTaskInfo" data-i18n="task.none">No tasks running</span><span
          id="settingHint" class="setting-hint" style="display:none"><span class="hint-text"
            data-i18n="settings.keyMissingShort">OpenAI Key 未设置</span> <a class="text-link" href="/settings"
            data-i18n="top.goSettings">去设置</a></span>
        <script>(function () { function A(el) { try { if (window.I18N && window.I18N.apply) { window.I18N.apply(el || document); } } catch (_) { } } function R() { try { if (!(window.I18N && window.I18N.dict)) return; var d = window.I18N.dict; function S(l, k, v) { try { d[l] = d[l] || {}; if (!Object.prototype.hasOwnProperty.call(d[l], k)) d[l][k] = v; } catch (_) { } } var k = 'settings.keyMissingShort'; S('zh-CN', k, 'OpenAI Key 未设置'); S('zh-TW', k, 'OpenAI Key 未設定'); S('en-US', k, 'OpenAI Key not set'); S('fr-FR', k, 'Clé OpenAI non définie'); S('es-ES', k, 'Clave OpenAI no configurada'); S('ru-RU', k, 'Ключ OpenAI не установлен'); S('de-DE', k, 'OpenAI-Schlüssel nicht gesetzt'); S('ja-JP', k, 'OpenAI キー未設定'); S('ko', k, 'OpenAI 키 미설정'); } catch (_) { } } function U() { return fetch('/api/settings').then(function (r) { return r.json(); }).then(function (j) { var el = document.getElementById('settingHint'); var info = document.getElementById('currentTaskInfo'); if (!el) return; var missing = !(j && j.ok && j.data && j.data.hasOpenaiKey); el.style.display = missing ? 'inline-flex' : 'none'; if (info) info.style.display = missing ? 'none' : ''; var box = document.querySelector('.translating-info'); if (box) box.style.display = ''; var statusEl = document.getElementById('dirStatusInfo'); if (statusEl) statusEl.style.display = 'none'; if (missing) { A(el); A(box); } }).catch(function () { try { var el = document.getElementById('settingHint'); var info = document.getElementById('currentTaskInfo'); var box = document.querySelector('.translating-info'); if (el) el.style.display = 'inline-flex'; if (info) info.style.display = 'none'; if (box) box.style.display = ''; var statusEl = document.getElementById('dirStatusInfo'); if (statusEl) statusEl.style.display = 'none'; try { A(el); A(box); } catch (_) { } } catch (_) { } }); } try { U(); } catch (_) { } try { if (!window.__st_topbar_fetch_wrapped) { window.__st_topbar_fetch_wrapped = true; var of = window.fetch; window.fetch = function (i, n) { var url = (typeof i === 'string') ? i : (i && i.url) || ''; var m = (n && (n.method || n.Method)) || (typeof i !== 'string' && i && i.method) || 'GET'; var p = of.apply(this, arguments); try { if (url.indexOf('/api/settings') === 0 && String(m).toUpperCase() === 'POST') { p.then(function () { setTimeout(U, 0); }); } } catch (_) { } return p; }; } } catch (_) { } try { document.addEventListener('visibilitychange', function () { if (!document.hidden) { U(); } }); } catch (_) { } try { document.addEventListener('DOMContentLoaded', function () { try { R(); if (window.I18N && window.I18N.apply) { window.I18N.apply(document); } } catch (_) { } }); } catch (_) { } })();</script>
      </div>
      <!-- <span class="divider" aria-hidden="true"></span> -->
      <!-- <div class="setting-hint"><span data-i18n="top.notConfigured">Translation options not set</span> <a class="text-link" href="/settings" data-i18n="top.goSettings">Go to Settings</a></div> -->
      <div class="actions">
        <div id="langSwitchApp"></div>
      </div>
    </div>

    <!-- Main -->
    <main class="main">
      <div class="main-scroll">
        <!-- 页面内容插槽开始 -->

        <script>
          (function () {
            const mountEl = document.getElementById('currentTaskInfo');
            if (!mountEl) return;
            const { createApp, ref, onMounted, onBeforeUnmount, computed } = Vue;
            const hostMountDirG = <% - JSON.stringify(typeof hostMountDir !== 'undefined' ? hostMountDir : "") %>;
            const App = {
              setup() {
                const task = ref(null);
                let timer = null; let readyTimer = null;
                // 防止重复订阅 I18N 语言变化
                let subscribed = false;
                // 当前语言（用于触发响应式依赖）
                const lang = ref((function () {
                  try { if (window.I18N && window.I18N.getLang) return window.I18N.getLang(); } catch (_) { }
                  try { return localStorage.getItem('ui_lang') || 'zh-CN'; } catch (_) { return 'zh-CN'; }
                })());
                // I18N 就绪哨兵（当 window.I18N 可用时递增，触发重新计算）
                const i18nReady = ref(0);
                const t = (k, params = {}) => {
                  try { if (window.I18N && window.I18N.t) return window.I18N.t(k, params); } catch (_) { }
                  return String(k).replace(/\{(\w+)\}/g, (m, p) => (params && (p in params) ? params[p] : m));
                };
                const poll = async () => {
                  try {
                    const resp = await fetch('/api/current-task');
                    const data = await resp.json();
                    if (data && data.ok) { task.value = data.task; }
                  } catch (e) { /* ignore */ }
                };
                onMounted(() => {
                  timer = setInterval(poll, 1500); poll();
                  // 订阅语言变化（当用户切换语言时触发重新计算）
                  try {
                    if (!subscribed && window.I18N && window.I18N.onChange) {
                      window.I18N.onChange((l) => { lang.value = l || lang.value; i18nReady.value++; });
                      subscribed = true;
                    }
                  } catch (_) { }
                  // 等待 I18N.t 就绪（初次加载时 window.I18N 可能尚未定义）
                  if (window.I18N && window.I18N.t) {
                    i18nReady.value++;
                  } else {
                    readyTimer = setInterval(() => {
                      if (window.I18N && window.I18N.t) {
                        i18nReady.value++;
                        // I18N 初始化完成后再补注册 onChange，以确保语言切换能触发更新
                        try {
                          if (!subscribed && window.I18N && window.I18N.onChange) {
                            window.I18N.onChange((l) => { lang.value = l || lang.value; i18nReady.value++; });
                            subscribed = true;
                          }
                          if (window.I18N && window.I18N.getLang) { lang.value = window.I18N.getLang(); }
                        } catch (_) { }
                        clearInterval(readyTimer);
                        readyTimer = null;
                      }
                    }, 100);
                  }
                });
                onBeforeUnmount(() => { if (timer) clearInterval(timer); if (readyTimer) clearInterval(readyTimer); });
                const full = (t0) => {
                  const nm = (t0 && t0.name) ? String(t0.name) : '';
                  const rel = (t0 && t0.dirRel) ? String(t0.dirRel) : '';
                  if (hostMountDirG) {
                    const sub = rel ? ('\\' + rel.replaceAll('/', '\\')) : '';
                    return (hostMountDirG + sub + '\\' + nm).replace(/\\\\/g, '\\');
                  }
                  return (`/${rel ? ('data/' + rel) : 'data'}/${nm}`).replace(/\\\\/g, '/');
                };
                const progress = (t0) => Math.round(Math.max(0, Math.min(100, Number(t0 && t0.progress) || 0)));
                const stageOf = (t0) => (t0 && t0.stage) || t('task.processing');
                // 显示文案：依赖 lang 与 i18nReady，确保 I18N 就绪后（即使 task 仍为 null）也会刷新
                const label = computed(() => {
                  const _lang = lang.value; const _tick = i18nReady.value; // 建立依赖
                  if (task.value && task.value.name) {
                    return t('task.running', { name: task.value.name, progress: progress(task.value) });
                  }
                  return t('task.none');
                });
                return { task, full, progress, stageOf, t, lang, i18nReady, label };
              },
              template: `
      <el-tooltip :disabled="!(task && task.name)" :content="task && task.name ? full(task) : ''" placement="bottom-start" effect="light">
        <span>{{ label }}</span>
      </el-tooltip>
    `
            };
            const app = Vue.createApp(App);
            app.use(ElementPlus, { locale: (function () { try { const v = (localStorage.getItem('ui_lang') || 'zh-cn').toLowerCase(); if (v === 'zh-cn' || v === 'zh') return window.ElementPlusLocaleZhCn; if (v === 'zh-tw' || v === 'zh-hant') return window.ElementPlusLocaleZhTw; if (v === 'en-us' || v === 'en') return window.ElementPlusLocaleEn; if (v === 'fr' || v.startsWith('fr-')) return window.ElementPlusLocaleFr; if (v === 'es' || v.startsWith('es-')) return window.ElementPlusLocaleEs; if (v === 'ru' || v.startsWith('ru-')) return window.ElementPlusLocaleRu; if (v === 'de' || v.startsWith('de-')) return window.ElementPlusLocaleDe; if (v === 'ja' || v.startsWith('ja-')) return window.ElementPlusLocaleJa; if (v === 'ko' || v.startsWith('ko-')) return window.ElementPlusLocaleKo; } catch (e) { } return undefined; })() });
            app.mount(mountEl);
          })();
        </script>