<%- include('partials/blank-wrapper-start.ejs') %>

<style>
  .tasks .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .tasks .header .title{font-size:22px;font-weight:700}
  .tasks .summary{color:var(--muted);font-size:13px;margin-left:10px}

  .tasks .toolbar{display:flex;align-items:center;gap:12px}
  .tasks .toolbar .sort{display:flex;align-items:center;gap:6px;color:#6b7280;font-size:14px;font-weight:600}
  .tasks .toolbar .sort .arrow{display:inline-flex;width:14px;height:14px;color:#9aa3b2}
  .icon-btn{height:36px;width:36px;display:inline-grid;place-items:center;border-radius:12px;background:#f4f7ff;border:1px solid #e6ecff;color:#6b7280;box-shadow:var(--shadow-soft);cursor:pointer}
  .icon-btn:hover{box-shadow:var(--shadow);filter:brightness(0.98)}
  .icon-btn.primary{background:linear-gradient(160deg,#6c8cff,#8aa2ff);color:#fff;border-color:transparent}

  .tasks .list{margin-top:10px;background:var(--panel);border:1px solid #eef2fb;border-radius:22px;box-shadow:var(--shadow-strong);overflow:hidden}
  .tasks table{width:100%;border-collapse:separate;border-spacing:0}
  .tasks thead th{background:#f6f8ff;text-align:left;color:#6b7280;font-weight:600;padding:14px}
  .tasks tbody td{padding:16px 14px;border-top:1px solid #eef2fb;vertical-align:middle}
  .tasks tbody tr:hover{background:#fafbff}

  .cover{width:64px;height:40px;border-radius:12px;background:linear-gradient(135deg,#eaf0ff,#f8fbff);border:1px solid #e9eeff;display:grid;place-items:center;color:#7aa1ff;box-shadow:var(--shadow-soft);position:relative;overflow:hidden}
  .cover .time-badge{position:absolute;bottom:6px;left:6px;font-size:11px;padding:2px 6px;border-radius:8px;background:rgba(17,24,39,.85);color:#fff}
  .tasks .name{font-weight:600}
  .tasks .meta{color:var(--muted);font-size:12px}

  .tasks .status{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:600;border:1px solid transparent}
  .tasks .status.done{background:#e9f7ee;color:#1f8a53;border-color:#cdf1dc}
  .tasks .status.doing{background:#eaf2ff;color:#3b82f6;border-color:#dbe5ff}

  .tasks .progress{display:flex;align-items:center;gap:8px}
  .tasks .progressbar{flex:1;height:8px;border-radius:999px;background:#eef2fb;overflow:hidden;box-shadow:inset 0 1px 2px rgba(0,0,0,.04);position:relative}
  .tasks .progressbar > i{display:block;height:100%;background:linear-gradient(90deg,#7aa1ff,#6c8cff)}
  .tasks .progressbar .progress-text{position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:12px;color:#64748b;font-weight:600}
  .tasks .percent{display:none}

  .recent{margin-top:18px}
  .recent .files{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
  .recent .card{display:grid;grid-template-columns:46px 1fr;align-items:center;gap:12px;background:var(--panel-tint);border:1px solid #eef2fb;border-radius:16px;padding:14px;box-shadow:var(--shadow-soft)}
  .recent .icon{width:46px;height:46px;border-radius:14px;display:grid;place-items:center;background:#eef2ff}
  @media (max-width: 1200px){ .recent .files{grid-template-columns:repeat(3,1fr)} }
  @media (max-width: 680px){ .recent .files{grid-template-columns:repeat(2,1fr)} }
</style>

<div class="tasks">
  <section class="section">
    <div class="header">
      <div>
        <span class="title" data-i18n="tasks.title">Tasks</span>
        <span class="summary" data-i18n="tasks.stat" data-i18n-params='{"n": <%= (tasks && tasks.length) || 0 %>}'>Stats: <%= (tasks && tasks.length) || 0 %> video files</span>
      </div>
      <div class="toolbar">
        <div class="sort"><span data-i18n="col.name">Name</span>
          <span class="arrow" aria-hidden="true">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 15l4-4 4 4"/></svg>
          </span>
        </div>
        <button class="icon-btn" type="button" data-i18n="tasks.view.list" data-i18n-attr="title,aria-label" title="List view" aria-label="List view">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
        </button>
        <button class="icon-btn primary" type="button" data-i18n="tasks.view.grid" data-i18n-attr="title,aria-label" title="Grid view" aria-label="Grid view">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h8v8H3zM13 3h8v8h-8zM3 13h8v8H3zM13 13h8v8h-8z"/></svg>
        </button>
      </div>
    </div>

    <div class="list">
      <table>
        <thead>
          <tr>
            <th style="width:80px" data-i18n="tasks.table.cover">Cover</th>
            <th data-i18n="tasks.table.filename">Filename</th>
            <th style="width:190px" data-i18n="tasks.table.createdAt">Created At</th>
            <th style="width:220px" data-i18n="tasks.table.progress">Progress</th>
            <th style="width:120px" data-i18n="tasks.table.status">Status</th>
            <th style="width:140px" data-i18n="tasks.table.actions">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if (tasks && tasks.length) { %>
            <% tasks.forEach(function(t){ %>
              <% const p = Math.min(100, Math.max(0, Number(t.progress)||0)); const done = p >= 100; %>
              <tr data-id="<%= t.id || '' %>" class="task-row<%= (activeId && t.id===activeId) ? ' active' : '' %>">
                <td>
                  <div class="cover">üé¨<% if (t.durationLabel) { %><span class="time-badge"><%= t.durationLabel %></span><% } %></div>
                </td>
                <td>
                  <div class="name"><%= t.name %></div>
                  <div class="meta"><%= t.sizeLabel %> ¬∑ <%= t.dateLabel %></div>
                </td>
                <td><%= t.dateLabel %></td>
                <td>
                  <div class="progress">
                    <div class="progressbar">
                      <i style="width:<%= p %>%;background:<%= done ? 'linear-gradient(90deg,#3ecf8e,#31c270)' : 'linear-gradient(90deg,#7aa1ff,#6c8cff)' %>"></i>
                      <% if (done) { %>
                        <span class="progress-text" data-i18n="tasks.progress.done">Completed</span>
                      <% } else { %>
                        <span class="progress-text" data-i18n="tasks.progress.processing" data-i18n-params='{"p": <%= p %>}'>Processing: <%= p %>%</span>
                      <% } %>
                    </div>
                  </div>
                </td>
                <td>
                  <span class="status <%= done ? 'done' : 'doing' %>" data-i18n="<%= done ? 'tasks.progress.done' : 'tasks.progress.processing' %>"><%= done ? 'Completed' : 'Processing' %></span>
                </td>
                <td style="display:flex;align-items:center;gap:8px">
                  <a class="btn sm" href="#"><span data-i18n="actions.button">Actions ‚ñæ</span></a>
                  <a class="icon-btn" style="width:32px;height:32px" data-i18n="tasks.open" data-i18n-attr="title" title="Open" aria-label="Open" href="#">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 3h7v7"/><path d="M10 14L21 3"/><path d="M21 14v7H3V3h7"/></svg>
                  </a>
                </td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr><td colspan="6" style="color:#94a3b8;padding:24px;text-align:center" data-i18n="tasks.none">No tasks</td></tr>
          <% } %>
        </tbody>
      </table>
    </div>

    <div class="recent">
      <div class="section-header" style="margin-bottom:10px">
        <div>
          <span class="title" data-i18n="nav.files">Recent Files</span>
          <span class="sub" data-i18n="blank.total" data-i18n-params='{"n":8}'>Recent 8</span>
        </div>
      </div>
      <div class="files grid">
        <% if (recent && recent.length) { %>
          <% recent.forEach(function(it){ %>
            <div class="card">
              <div class="icon">
                <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="4" y="4" width="16" height="16" rx="4" fill="#eaf1ff"/>
                  <path d="M8 13l2.5-2.5L13 13l2.5-2.5L18 13" stroke="#7aa1ff"/>
                </svg>
              </div>
              <div class="meta-row">
                <div>
                  <div class="name"><%= it.name %></div>
                  <div class="meta"><%= it.dateLabel %></div>
                </div>
                <div class="size"><%= it.sizeLabel %></div>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <div style="color:#94a3b8;padding:24px;grid-column:1/-1" data-i18n="files.none">No files</div>
        <% } %>
      </div>
    </div>
  </section>
</div>

<script>
(function(){
  const activeId = '<%- (typeof activeId !== 'undefined' ? activeId : '') %>';
  if(!activeId) return;

  const row = document.querySelector(`tr.task-row[data-id="${CSS.escape(activeId)}"]`);
  if(row){ row.classList.add('active'); }

  const updateRow = (p, statusText) => {
    const bar = row && row.querySelector('.progressbar > i');
    const text = row && row.querySelector('.progressbar .progress-text');
    const badge = row && row.querySelector('.status');
    if(bar){ bar.style.width = p + '%'; bar.style.background = p>=100 ? 'linear-gradient(90deg,#3ecf8e,#31c270)' : 'linear-gradient(90deg,#7aa1ff,#6c8cff)'; }
    if(text){ text.textContent = p>=100 ? ((window.I18N && window.I18N.t) ? window.I18N.t('tasks.progress.done') : 'Completed') : ((window.I18N && window.I18N.t) ? window.I18N.t('tasks.progress.processing',{p:p}) : ('Processing: ' + p + '%')); }
    if(badge){ badge.classList.toggle('done', p>=100); badge.classList.toggle('doing', p<100); badge.textContent = p>=100 ? ((window.I18N && window.I18N.t) ? window.I18N.t('tasks.progress.done') : 'Completed') : ((window.I18N && window.I18N.t) ? window.I18N.t('tasks.progress.processing',{p:p}) : 'Processing'); }
  };

  let timer = null;
  const poll = async () => {
    try{
      const resp = await fetch(`/api/tasks/${encodeURIComponent(activeId)}/progress`);
      const data = await resp.json();
      if(data && data.ok){
        const p = Math.max(0, Math.min(100, Number(data.progress)||0));
        updateRow(p, data.status || 'processing');
        if(p>=100 || (data.status && data.status==='error')){
          if(timer){ clearInterval(timer); timer=null; }
        }
      } else {
        if(timer){ clearInterval(timer); timer=null; }
      }
    } catch(e){
      // ÁΩëÁªúÈîôËØØÔºåÁ®çÂêéÁªßÁª≠
    }
  };
  timer = setInterval(poll, 1500);
  poll();
})();
</script>

<%- include('partials/blank-wrapper-end.ejs') %>