<%- include('partials/blank-wrapper-start.ejs') %>

  <style>
    .settings .section-header .title {
      font-size: 22px;
      font-weight: 700
    }

    .settings .card {
      background: var(--panel);
      border: 1px solid #eef2fb;
      border-radius: 18px;
      padding: 16px 18px;
      box-shadow: var(--shadow-soft)
    }

    .settings .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px
    }

    @media (min-width: 920px) {
      .settings .grid {
        grid-template-columns: 1fr 1fr
      }
    }

    .actions.right {
      display: flex;
      justify-content: flex-end;
      margin-top: 16px
    }

    /* 优化 Element Plus 在本页的间距与圆角 */
    .el-card {
      border-radius: 16px
    }

    .fieldset {
      border: 1px solid #e9eefb;
      border-radius: 14px;
      padding: 14px;
      background: #fafbff;
      margin-top: 14px
    }

    .group-title {
      font-weight: 700;
      font-size: 16px;
      margin: 2px 0 12px
    }

    .el-col {
      margin-bottom: 20px;
    }
  </style>

  <!-- 改为标签模板：将原先 JS 字符串模板移入 DOM 中，供 Vue 直接编译使用 -->
  <div id="settingsApp">
    <el-config-provider :locale="elLocale">
      <div class="settings">
        <section class="section">
          <div class="section-header">
            <div>
              <span class="title" data-i18n="settings.title">Settings</span>
              <span class="sub" data-i18n="settings.sub">Global Preferences &amp; Behavior</span>
            </div>
          </div>
          <el-skeleton :loading="loading" animated>
            <template #template>
              <el-skeleton-item variant="rect" style="height:180px;margin-bottom:14px"></el-skeleton-item>
              <el-skeleton-item variant="rect" style="height:140px;margin-bottom:14px"></el-skeleton-item>
              <el-skeleton-item variant="rect" style="height:320px;margin-bottom:14px"></el-skeleton-item>
            </template>
            <template #default>
              <el-row :gutter="14">
                <el-col :xs="24" :md="12">
                  <el-card shadow="hover" body-style="padding: 16px">
                    <div class="group-title">{{ t('settings.serviceType') }}</div>
                    <el-radio-group v-model="state.form.svc" size="large">
                      <el-radio-button v-for="o in svcOptions" :key="o.value" :label="o.value">{{ o.label
                        }}</el-radio-button>
                    </el-radio-group>
                    <div v-show="state.form.svc==='openai'" class="fieldset" style="margin-top:12px">
                      <legend style="font-weight:700;color:#64748b;font-size:13px">{{ t('settings.openaiOptions') }}
                      </legend>
                      <div v-if="state.hasOpenaiKey && !state.editingKey"
                        style="display:flex;align-items:center;justify-content:space-between;gap:10px">
                        <div>
                          <span class="desc" style="margin:0" data-i18n="settings.keyStatus">OpenAI Key Status:</span>
                          <span style="color:#16a34a;font-weight:700" data-i18n="settings.keySet">Set</span>
                        </div>
                        <el-button @click="state.editingKey=true" type="primary" plain><span
                            data-i18n="settings.edit">Edit</span></el-button>
                      </div>
                      <div v-else style="margin-top:8px">
                        <el-input v-model="state.form.openaiKey" type="password" show-password
                          placeholder="openai key"></el-input>
                        <div class="actions right">
                          <el-button type="primary" :loading="savingSvc" @click="saveService"><span
                              data-i18n="settings.save">Save settings</span></el-button>
                        </div>
                      </div>
                    </div>
                    <div v-show="state.form.svc==='pro'" class="fieldset" style="margin-top:12px">
                      <legend style="font-weight:700;color:#64748b;font-size:13px">{{ t('settings.proOptions') }}
                      </legend>
                      <div style="display:flex;align-items:center;justify-content:space-between;gap:16px">
                        <div class="desc" data-i18n="settings.notLoggedIn">Not logged in. Log in to use pro features and
                          synced quota.</div>
                        <el-button type="primary" @click="location.href='/login'"><span data-i18n="settings.login">Log
                            In</span></el-button>
                      </div>
                    </div>
                  </el-card>
                </el-col>

                <el-col :xs="24" :md="12">
                  <el-card shadow="hover" body-style="padding: 16px">
                    <div class="group-title">{{ t('settings.extFilters') || 'Extensions Filter' }}</div>
                    <el-form>
                      <el-form-item>
                        <template #label>{{ t('settings.videoExts') || 'Video Exts' }}</template>
                        <el-select v-model="state.form.videoExts" multiple filterable allow-create default-first-option
                          placeholder=".mp4, .mkv, .mov, .avi, .m4v, .webm">
                          <el-option v-for="opt in videoExtOptions" :key="opt.value" :label="opt.label"
                            :value="opt.value" />
                        </el-select>
                      </el-form-item>
                      <el-form-item>
                        <template #label>{{ t('settings.subExts') || 'Subtitle Exts' }}</template>
                        <el-select v-model="state.form.subExts" multiple filterable allow-create default-first-option
                         placeholder="srt, ass, vtt">
                          <el-option v-for="opt in subExtOptions" :key="opt.value" :label="opt.label"
                            :value="opt.value" />
                        </el-select>
                      </el-form-item>
                      <div style="color:#64748b;font-size:12px;line-height:1.5">
                        <span data-i18n="settings.extTips">Tips: Values are case-insensitive. Video exts will be normalized to ".ext"; subtitle exts to "ext". Duplicates will be removed.</span>
                      </div>
                    </el-form>
                    <div class="actions right">
                      <el-button type="primary" :loading="savingExts" @click="saveExts"><span
                          data-i18n="settings.save">Save settings</span></el-button>
                    </div>
                  </el-card>
                </el-col>
<!-- 
                <el-col :xs="24">
                  <el-card shadow="hover" body-style="padding: 16px">
                    <div class="group-title">{{ t('settings.translateOptions') }}</div>
                    <el-row :gutter="14">
                      <el-col :xs="24" :md="12" style="margin-bottom:0">
                        <el-form label-width="120px">
                          <el-form-item>
                            <template #label>{{ t('settings.sourceLabel') }}</template>
                            <el-select v-model="state.form.srcLang" :placeholder="t('settings.selectSrc')">
                              <el-option v-for="o in langs" :key="o.value" :label="o.label"
                                :value="o.value"></el-option>
                            </el-select>
                          </el-form-item>
                          <el-form-item>
                            <template #label>{{ t('settings.targetLabel') }}</template>
                            <el-select v-model="state.form.tgtLang" :placeholder="t('settings.selectTgt')">
                              <el-option v-for="o in langs.filter(x=>x.value!=='auto')" :key="o.value" :label="o.label"
                                :value="o.value"></el-option>
                            </el-select>
                          </el-form-item>
                          <el-form-item>
                            <template #label>{{ t('settings.modelsLabel') }}</template>
                            <el-select v-model="state.form.model" :placeholder="t('settings.selectModel')">
                              <el-option v-for="m in models" :key="m.value" :label="m.label"
                                :value="m.value"></el-option>
                            </el-select>
                          </el-form-item>
                        </el-form>
                      </el-col>
                      <el-col :xs="24" :md="12" style="margin-bottom:0">
                        <el-form label-width="120px">
                          <el-form-item>
                            <template #label>{{ t('settings.profilesLabel') }}</template>
                            <el-select v-model="state.form.profile" :placeholder="t('settings.selectProfile')">
                              <el-option v-for="p in profiles" :key="p.value" :label="p.label"
                                :value="p.value"></el-option>
                            </el-select>
                          </el-form-item>
                          <el-form-item>
                            <template #label>{{ t('settings.customPrompt') }}</template>
                            <el-input v-model="state.form.prompt" type="textarea" :autosize="{minRows:4,maxRows:8}"
                              :placeholder="t('settings.promptPlaceholder')"></el-input>
                          </el-form-item>
                          <el-form-item>
                            <template #label>{{ t('settings.polish') }}</template>
                            <el-switch v-model="state.form.polish"></el-switch>
                          </el-form-item>
                        </el-form>
                      </el-col>
                    </el-row>
                    <div class="actions right">
                      <el-button type="primary" :loading="savingTranslate" @click="saveTranslate"><span
                          data-i18n="settings.save">Save settings</span></el-button>
                    </div>
                  </el-card>
                </el-col> -->

              </el-row>
              <div class="actions right">
              </div>
            </template>
          </el-skeleton>
        </section>
      </div>
    </el-config-provider>
  </div>

  <script>
    (() => {
      const { createApp, ref, reactive, onMounted, watch, computed, nextTick } = Vue;
      const App = {
        setup() {
          const loading = ref(true);
          const saving = ref(false);
          const lang = ref((window.I18N && typeof window.I18N.getLang === 'function') ? window.I18N.getLang() : (localStorage.getItem('ui_lang') || 'zh-CN'));
          const i18nVersion = ref(0);
          const i18nBound = ref(false);
          const bindI18N = () => {
            if (i18nBound.value) return;
            if (window.I18N && typeof window.I18N.onChange === 'function') {
              try {
                window.I18N.onChange((l) => {
                  lang.value = l;
                  try { i18nVersion.value++; } catch (_) { }
                  try { window.I18N.apply && window.I18N.apply(); } catch (_) { }
                });
                i18nBound.value = true;
              } catch (_) { }
            }
          };
          // 初次尝试绑定，并在 I18N 可能延迟初始化时重试一次
          bindI18N();
          if (!i18nBound.value) {
            const _i18nBindTimer = setInterval(() => {
              if (i18nBound.value) { clearInterval(_i18nBindTimer); return; }
              if (window.I18N && typeof window.I18N.onChange === 'function') {
                bindI18N();
                if (i18nBound.value) clearInterval(_i18nBindTimer);
              }
            }, 200);
            setTimeout(() => { try { clearInterval(_i18nBindTimer); } catch (_) { } }, 10000);
          }
          const t = (k, params) => { lang.value; i18nVersion.value; return (window.I18N && window.I18N.t) ? window.I18N.t(k, params) : k; };
          function epLocaleOf(v) {
            v = (v || '').toLowerCase();
            if (v === 'zh-cn' || v === 'zh') return window.ElementPlusLocaleZhCn;
            if (v === 'zh-tw' || v === 'zh-hant') return window.ElementPlusLocaleZhTw;
            if (v === 'en-us' || v === 'en') return window.ElementPlusLocaleEn;
            if (v === 'fr' || v.startsWith('fr-')) return window.ElementPlusLocaleFr;
            if (v === 'es' || v.startsWith('es-')) return window.ElementPlusLocaleEs;
            if (v === 'ru' || v.startsWith('ru-')) return window.ElementPlusLocaleRu;
            if (v === 'de' || v.startsWith('de-')) return window.ElementPlusLocaleDe;
            if (v === 'ja' || v.startsWith('ja-')) return window.ElementPlusLocaleJa;
            if (v === 'ko' || v.startsWith('ko-')) return window.ElementPlusLocaleKo;
            return undefined;
          }
          const elLocale = computed(() => epLocaleOf(lang.value));
          watch(() => lang.value, async () => {
            try { await nextTick(); } catch (_) { }
            try {
              if (window.I18N && typeof window.I18N.apply === 'function') {
                const root = document.getElementById('settingsApp') || document;
                window.I18N.apply(root);
              }
            } catch (_) { }
          });

          const state = reactive({
            hasOpenaiKey: false,
            editingKey: false,
            form: {
              svc: 'openai',
              openaiKey: '',
              autoGenerate: false,
              autoTranslate: false,
              srcLang: 'auto',
              tgtLang: '',
              model: '',
              profile: '',
              prompt: '',
              polish: false,
              videoExts: ['.mp4', '.mkv', '.mov', '.avi', '.m4v', '.webm'],
              subExts: ['srt', 'ass', 'vtt']
            }
          });
          // 新增：登录状态（由后端返回，默认未登录）
          const isLoggedIn = ref(false);
          // 临时缓存未保存的 OpenAI Key，避免页面跳转后输入丢失
          const TEMP_KEY_STORAGE = 'st_tmp_openai_key';
          watch(() => state.form.openaiKey, (v) => {
            try { localStorage.setItem(TEMP_KEY_STORAGE, v || ''); } catch (_) { }
          });

          const fetchSettings = async () => {
            try {
              const r = await fetch('/api/settings');
              const j = await r.json();
              const s = j && j.data ? j.data : null;
              if (s) {
                if (s.svc) state.form.svc = s.svc;
                state.form.autoGenerate = !!s.autoGenerate;
                state.form.autoTranslate = !!s.autoTranslate;
                if (s.srcLang) state.form.srcLang = s.srcLang;
                if (s.tgtLang) state.form.tgtLang = s.tgtLang || '';
                if (s.model) state.form.model = s.model || '';
                if (s.profile) state.form.profile = s.profile || '';
                state.form.prompt = s.prompt || '';
                state.form.polish = !!s.polish;
                state.hasOpenaiKey = !!s.hasOpenaiKey;
                state.editingKey = !state.hasOpenaiKey;
                // 新增：登录态
                isLoggedIn.value = !!s.isLoggedIn;
                // 新增：扩展名设置
                state.form.videoExts = Array.isArray(s.videoExts) ? s.videoExts : [];
                state.form.subExts = Array.isArray(s.subExts) ? s.subExts : [];
              } else {
                state.editingKey = true;
              }
            } catch (e) {
              state.editingKey = true;
            } finally {
              // 若当前处于编辑 Key 状态，从本地恢复未保存的 Key
              try {
                if (state.editingKey) {
                  const tmp = localStorage.getItem(TEMP_KEY_STORAGE);
                  if (tmp && !state.form.openaiKey) state.form.openaiKey = tmp;
                }
              } catch (_) { }
              loading.value = false;
              try { await nextTick(); if (window.I18N && window.I18N.apply) { window.I18N.apply(); } } catch (_) { }
            }
          };

          // 监听自动队列 & i18n 应用
          watch(loading, async (v) => {
            if (!v) {
              try { await nextTick(); if (window.I18N && window.I18N.apply) { window.I18N.apply(); } } catch (_) { }
            }
          });

          const save = async () => {
            saving.value = true;
            try {
              // 直接使用多选下拉绑定的数组
              const payload = {
                svc: state.form.svc,
                // 仅当正在编辑 Key 时才提交 openaiKey 字段；否则完全不包含，避免被置空
                ...(state.editingKey ? { openaiKey: (state.form.openaiKey ?? '') } : {}),
                autoGenerate: state.form.autoGenerate,
                autoTranslate: state.form.autoTranslate,
                srcLang: state.form.srcLang || null,
                tgtLang: state.form.tgtLang || null,
                model: state.form.model || null,
                profile: state.form.profile || null,
                prompt: state.form.prompt || '',
                polish: !!state.form.polish,
                videoExts: Array.isArray(state.form.videoExts) ? state.form.videoExts : [],
                subExts: Array.isArray(state.form.subExts) ? state.form.subExts : [],
              };
              const resp = await fetch('/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
              const data = await resp.json().catch(() => null);
              if (data && data.ok) {
                // 如果这次保存包含了 openaiKey，则根据是否为空更新 hasOpenaiKey
                if (state.editingKey) {
                  const trimmed = (state.form.openaiKey || '').trim();
                  state.hasOpenaiKey = !!trimmed;
                  state.editingKey = false;
                  state.form.openaiKey = '';
                  try { localStorage.removeItem(TEMP_KEY_STORAGE); } catch (_) { }
                }
                ElementPlus.ElMessage.success(t('msg.ok'));
              } else {
                ElementPlus.ElMessage.error(t('msg.saveFail'));
              }
            } catch (e) {
              ElementPlus.ElMessage.error(t('msg.saveFail'));
            } finally {
              saving.value = false;
            }
          };

          // 分区独立保存：服务类型、翻译选项、扩展名过滤
          const savingSvc = ref(false);
          const savingTranslate = ref(false);
          const savingExts = ref(false);

          const getRemoteSettings = async () => {
            try {
              const r = await fetch('/api/settings');
              const j = await r.json();
              return (j && j.data) ? j.data : null;
            } catch (_) { return null; }
          };

          const saveService = async () => {
            savingSvc.value = true;
            
            // 验证 OpenAI key
            if (state.form.svc === 'openai' && state.editingKey) {
              const trimmedKey = (state.form.openaiKey || '').trim();
              if (!trimmedKey) {
                ElementPlus.ElMessage.warning('请输入 OpenAI Key');
                savingSvc.value = false;
                return;
              }
              
              // 验证 OpenAI Key 是否可用
              try {
                const testResp = await fetch('https://api.openai.com/v1/models', {
                  headers: { 'Authorization': `Bearer ${trimmedKey}` }
                });
                if (!testResp.ok) {
                  ElementPlus.ElMessage.error('OpenAI Key 无效，请检查后重试');
                  savingSvc.value = false;
                  return;
                }
              } catch (e) {
                ElementPlus.ElMessage.error('无法验证 OpenAI Key，请检查网络连接');
                savingSvc.value = false;
                return;
              }
            }
              
            try {
              const baseline = await getRemoteSettings();
              const b = baseline || {};
              const payload = {
                svc: state.form.svc,
                ...(state.editingKey ? { openaiKey: (state.form.openaiKey ?? '') } : {}),
                autoGenerate: !!b.autoGenerate,
                autoTranslate: !!b.autoTranslate,
                srcLang: b.srcLang || null,
                tgtLang: b.tgtLang || null,
                model: b.model || null,
                profile: b.profile || null,
                prompt: b.prompt || '',
                polish: !!b.polish,
                videoExts: Array.isArray(b.videoExts) ? b.videoExts : [],
                subExts: Array.isArray(b.subExts) ? b.subExts : [],
              };
              const resp = await fetch('/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
              const data = await resp.json().catch(() => null);
              if (data && data.ok) {
                if (state.editingKey) {
                  const trimmed = (state.form.openaiKey || '').trim();
                  state.hasOpenaiKey = !!trimmed;
                  state.editingKey = false;
                  state.form.openaiKey = '';
                  try { localStorage.removeItem(TEMP_KEY_STORAGE); } catch (_) { }
                }
                ElementPlus.ElMessage.success(t('msg.ok'));
                try { await fetchSettings(); } catch (_) { }
              } else {
                ElementPlus.ElMessage.error(t('msg.saveFail'));
              }
            } catch (e) {
              ElementPlus.ElMessage.error(t('msg.saveFail'));
            } finally {
              savingSvc.value = false;
            }
          };

          const saveTranslate = async () => {
            savingTranslate.value = true;
            try {
              const baseline = await getRemoteSettings();
              const b = baseline || {};
              const payload = {
                svc: typeof b.svc === 'string' ? b.svc : state.form.svc,
                autoGenerate: !!b.autoGenerate,
                autoTranslate: !!b.autoTranslate,
                srcLang: state.form.srcLang || null,
                tgtLang: state.form.tgtLang || null,
                model: state.form.model || null,
                profile: state.form.profile || null,
                prompt: state.form.prompt || '',
                polish: !!state.form.polish,
                videoExts: Array.isArray(b.videoExts) ? b.videoExts : [],
                subExts: Array.isArray(b.subExts) ? b.subExts : [],
              };
              const resp = await fetch('/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
              const data = await resp.json().catch(() => null);
              if (data && data.ok) {
                ElementPlus.ElMessage.success(t('msg.ok'));
                try { await fetchSettings(); } catch (_) { }
              } else {
                ElementPlus.ElMessage.error(t('msg.saveFail'));
              }
            } catch (e) {
              ElementPlus.ElMessage.error(t('msg.saveFail'));
            } finally {
              savingTranslate.value = false;
            }
          };

          const saveExts = async () => {
            savingExts.value = true;
            try {
              const baseline = await getRemoteSettings();
              const b = baseline || {};
              const payload = {
                svc: typeof b.svc === 'string' ? b.svc : state.form.svc,
                autoGenerate: !!b.autoGenerate,
                autoTranslate: !!b.autoTranslate,
                srcLang: b.srcLang || null,
                tgtLang: b.tgtLang || null,
                model: b.model || null,
                profile: b.profile || null,
                prompt: b.prompt || '',
                polish: !!b.polish,
                videoExts: Array.isArray(state.form.videoExts) ? state.form.videoExts : [],
                subExts: Array.isArray(state.form.subExts) ? state.form.subExts : [],
              };
              const resp = await fetch('/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
              const data = await resp.json().catch(() => null);
              if (data && data.ok) {
                ElementPlus.ElMessage.success(t('msg.ok'));
                try { await fetchSettings(); } catch (_) { }
              } else {
                ElementPlus.ElMessage.error(t('msg.saveFail'));
              }
            } catch (e) {
              ElementPlus.ElMessage.error(t('msg.saveFail'));
            } finally {
              savingExts.value = false;
            }
          };

          // 新增：切换守卫 - 生成字幕需先配置 OpenAI Key；开启时立刻保存以触发后端立即入队
          const onToggleGenerate = async (val) => {
            try {
              if (val && !state.hasOpenaiKey && !state.form.openaiKey) {
                state.form.autoGenerate = false;
                try {
                  ElementPlus.ElMessageBox.alert(
                    (window.I18N && window.I18N.t ? window.I18N.t('settings.autoQueueAlert') : '当前未设置 OpenAI Key，自动任务将无法开始，请先填写 Key 并保存'),
                    t('settings.title')
                  );
                } catch (_) {
                  ElementPlus.ElMessage.warning(t('settings.autoQueueAlert'));
                }
                return;
              }
              // 若已设置 Key 且切换为开启，自动保存设置，后端在保存后会即时调用 maybeAutoEnqueueNext
              if (val && state.hasOpenaiKey) {
                try { await save(); } catch (_) { }
              }
            } catch (_) { }
          };
          // 新增：切换守卫 - 翻译字幕需登录
          const onToggleTranslate = (val) => {
            try {
              if (val && !isLoggedIn.value) {
                state.form.autoTranslate = false;
                try {
                  ElementPlus.ElMessageBox.confirm(
                    t('settings.notLoggedIn'),
                    t('settings.login'),
                    { confirmButtonText: t('settings.login'), cancelButtonText: t('settings.off'), type: 'warning' }
                  ).then(() => { location.href = '/login'; }).catch(() => { });
                } catch (_) {
                  ElementPlus.ElMessage.warning(t('settings.notLoggedIn'));
                }
              }
            } catch (_) { }
          };

          const svcOptions = computed(() => ([
            { label: 'openai', value: 'openai' },
            // { label: t('settings.proOptions'), value: 'pro' },
          ]));
          const langs = [
            { label: 'Auto Detect (Auto)', value: 'auto' },
            { label: 'Chinese (Simplified) (ZH-CN)', value: 'zh-CN' },
            { label: 'English (EN)', value: 'en' },
            { label: 'Japanese (JA)', value: 'ja' },
          ];
          const models = [
            { label: 'Meta Llama 3 405B Instruct', value: 'llama-3-405b' },
            { label: 'OpenAI GPT-4o mini', value: 'gpt-4o-mini' },
            { label: 'Claude 3.5 Sonnet', value: 'claude-3-5-sonnet' },
          ];
          const profiles = [
            { label: 'General Expert', value: 'general' },
            { label: 'Subtitle Expert', value: 'subtitle' },
            { label: 'Technical', value: 'technical' },
            { label: 'Marketing', value: 'marketing' },
          ];

          // 多选下拉的可选项（默认 + 当前值去重）
          const videoExtDefaults = ['.mp4', '.mkv', '.mov', '.avi', '.m4v', '.webm'];
          const subExtDefaults = ['srt', 'ass', 'vtt'];
          const videoExtOptions = computed(() => {
            const set = new Set([...(videoExtDefaults || []), ...((state.form.videoExts) || [])]);
            return Array.from(set).map(v => ({ label: v, value: v }));
          });
          const subExtOptions = computed(() => {
            const set = new Set([...(subExtDefaults || []), ...((state.form.subExts) || [])]);
            return Array.from(set).map(v => ({ label: v, value: v }));
          });

          onMounted(fetchSettings);

          return { loading, saving, state, save, t, elLocale, svcOptions, langs, models, profiles, videoExtOptions, subExtOptions, onToggleGenerate, onToggleTranslate, isLoggedIn, savingSvc, savingTranslate, savingExts, saveService, saveTranslate, saveExts };
        }
      };

      const mount = document.getElementById('settingsApp');
      if (mount) {
        const app = Vue.createApp(App);
        function epLocaleOf(v) {
          v = (v || '').toLowerCase();
          if (v === 'zh-cn' || v === 'zh') return window.ElementPlusLocaleZhCn;
          if (v === 'zh-tw' || v === 'zh-hant') return window.ElementPlusLocaleZhTw;
          if (v === 'en-us' || v === 'en') return window.ElementPlusLocaleEn;
          if (v === 'fr' || v.startsWith('fr-')) return window.ElementPlusLocaleFr;
          if (v === 'es' || v.startsWith('es-')) return window.ElementPlusLocaleEs;
          if (v === 'ru' || v.startsWith('ru-')) return window.ElementPlusLocaleRu;
          if (v === 'de' || v.startsWith('de-')) return window.ElementPlusLocaleDe;
          if (v === 'ja' || v.startsWith('ja-')) return window.ElementPlusLocaleJa;
          if (v === 'ko' || v.startsWith('ko-')) return window.ElementPlusLocaleKo;
          return undefined;
        }
        const initLang = (localStorage.getItem('ui_lang') || 'zh-CN');
        app.use(ElementPlus, { locale: epLocaleOf(initLang) });
        app.mount(mount);
      }
    })();
  </script>

  <%- include('partials/blank-wrapper-end.ejs') %>